<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>á”áŸ’ášá–áŸá“áŸ’á’á–á·á“á·ááŸ’á™á›á‘áŸ’á’á•á›áŸá·á€áŸ’áŸá¶ - áœá·á‘áŸ’á™á¶á›áŸá™ á áŸŠá»á“ áŸáŸ‚á“ á€áŸ†á–á„áŸ‹ááŸ’ášá¡á¶á…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;700&family=Moul&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --primary-blue: #1e40af;
            --khmer-red: #dc2626;
        }
        body { 
            font-family: 'Kantumruy Pro', sans-serif; 
            background: #f1f5f9;
            color: #1e293b;
        }
        .moul-font { font-family: 'Moul', serif; }
        .print-area {
            background: white;
            width: 210mm;
            min-height: 297mm;
            margin: 20px auto;
            padding: 12mm 15mm;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .sketch-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1.5px solid #e2e8f0;
            border-radius: 12px;
            margin: 20px 0;
            padding: 12px 0;
            background: #ffffff;
        }
        .sketch-item {
            flex: 1;
            text-align: center;
            position: relative;
        }
        .sketch-item:not(:last-child)::after {
            content: "";
            position: absolute;
            right: 0;
            top: 10%;
            height: 80%;
            width: 1px;
            background-color: #e2e8f0;
        }
        .sketch-label {
            font-size: 11px;
            color: #64748b;
            font-weight: bold;
            margin-bottom: 2px;
        }
        .sketch-value {
            font-size: 22px;
            font-weight: 800;
        }

        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #cbd5e1; padding: 6px 4px; text-align: center; font-size: 12px; }
        th { background-color: #f8fafc; color: var(--primary-blue); font-weight: 700; height: 35px; }
        .subject-col { text-align: left; padding-left: 10px; font-weight: bold; font-size: 13px; width: 140px; }
        
        .progress-container {
            width: 100%;
            background-color: #f1f5f9;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
        }
        .progress-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .grade-A { color: #059669; }
        .grade-B { color: #2563eb; }
        .grade-C { color: #d97706; }
        .grade-D { color: #7c3aed; }
        .grade-E { color: #db2777; }
        .grade-F { color: #dc2626; }

        @media print {
            body { background: white; }
            .no-print { display: none !important; }
            .print-area { box-shadow: none; margin: 0; padding: 10mm; width: 100%; }
        }
    </style>
</head>
<body>

    <!-- Search Section -->
    <div class="max-w-4xl mx-auto my-6 no-print px-4">
        <div class="text-center mb-6 space-y-2">
            <h2 class="moul-font text-blue-800 text-lg">áœá·á‘áŸ’á™á¶á›áŸá™ á áŸŠá»á“ áŸáŸ‚á“ á€áŸ†á–á„áŸ‹ááŸ’ášá¡á¶á…</h2>
            <p class="font-bold text-gray-500">á”áŸ’ášá–áŸá“áŸ’á’ááŸ’ášá½áá–á·á“á·ááŸ’á™á›á‘áŸ’á’á•á›áŸá·á€áŸ’áŸá¶áŸá·áŸáŸ’áŸ</p>
        </div>
        
        <div class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-blue-600">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="space-y-1">
                    <label class="text-xs font-bold text-gray-500">á‡áŸ’ášá¾áŸášá¾áŸááŸ‚/á†á˜á¶áŸ</label>
                    <select id="monthSelect" class="w-full p-3 rounded-xl bg-gray-50 border border-gray-200 outline-none font-bold text-sm">
                        <option value="á˜á€ášá¶">á˜á€ášá¶</option><option value="á€á»á˜áŸ’á—áŸˆ">á€á»á˜áŸ’á—áŸˆ</option><option value="á˜á¸á“á¶">á˜á¸á“á¶</option>
                        <option value="á˜áŸáŸá¶">á˜áŸáŸá¶</option><option value="á§áŸá—á¶">á§áŸá—á¶</option><option value="á˜á·áá»á“á¶">á˜á·áá»á“á¶</option>
                        <option value="á€á€áŸ’á€áŠá¶">á€á€áŸ’á€áŠá¶</option><option value="áŸá¸á á¶">áŸá¸á á¶</option><option value="á€á‰áŸ’á‰á¶">á€á‰áŸ’á‰á¶</option>
                        <option value="áá»á›á¶">áá»á›á¶</option><option value="áœá·á…áŸ’á†á·á€á¶">áœá·á…áŸ’á†á·á€á¶</option><option value="á’áŸ’á“á¼">á’áŸ’á“á¼</option>
                        <option value="á”áŸ’ášá¡á„á†á˜á¶áŸá‘á¸áŸ¡">á”áŸ’ášá¡á„á†á˜á¶áŸá‘á¸áŸ¡</option><option value="á”áŸ’ášá¡á„á†á˜á¶áŸá‘á¸áŸ¢">á”áŸ’ášá¡á„á†á˜á¶áŸá‘á¸áŸ¢</option>
                        <option value="á”áŸ’ášá…á¶áŸ†á†áŸ’á“á¶áŸ†">á”áŸ’ášá…á¶áŸ†á†áŸ’á“á¶áŸ†</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-gray-500">á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡ á¬ á¢ááŸ’áá›áŸá</label>
                    <div class="flex gap-2">
                        <input type="text" id="searchInput" class="w-full p-3 rounded-xl bg-gray-50 border border-gray-200 outline-none font-bold text-sm" placeholder="áŸáŸ’áœáŸ‚á„ášá€á‘á¸á“áŸáŸ‡...">
                        <button onclick="startScanner()" class="bg-gray-100 p-3 rounded-xl hover:bg-gray-200 border border-gray-200 transition-all text-blue-600" title="áŸáŸ’á€áŸá“á€á¼áŠ QR">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M0 .5A.5.5 0 0 1 .5 0h3a.5.5 0 0 1 0 1H1v2.5a.5.5 0 0 1-1 0v-3Zm12 0a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0V1h-2.5a.5.5 0 0 1-.5-.5ZM.5 12a.5.5 0 0 1 .5.5V15h2.5a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5Zm15 0a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1H15v-2.5a.5.5 0 0 1 .5-.5ZM4 4h1v1H4V4Z"/>
                                <path d="M7 2H2v5h5V2ZM3 3h3v3H3V3Zm2 8H4v1h1v-1Z"/>
                                <path d="M7 9H2v5h5V9Zm-4 1h3v3H3v-3Zm8-6h1v1h-1V4Z"/>
                                <path d="M9 2h5v5H9V2Zm1 1v3h3V3h-3ZM8 8v2h1v1H8v1h2v-2h1v2h1v-1h2v-1h-3V8H8Zm2 2H9V9h1v1Zm4 2h-1v1h-2v1h3v-2Zm-4 2v-1H8v1h2Z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="flex items-end">
                    <button onclick="handleSearch()" id="searchBtn" class="w-full bg-blue-600 text-white p-3 rounded-xl font-bold hover:bg-blue-700 transition-all flex items-center justify-center gap-2 shadow-lg">
                        <span>á†áŸ‚á€á˜á¾á›á›á‘áŸ’á’á•á›</span>
                        <div id="loader" class="hidden animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></div>
                    </button>
                </div>
            </div>

            <div id="qr-reader" class="mt-4 hidden w-full overflow-hidden rounded-xl border-2 border-dashed border-blue-400"></div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="capture-area" class="print-area hidden">
        <div class="text-center space-y-1">
            <h2 class="moul-font text-[13px] text-blue-900">á–áŸ’ášáŸ‡ášá¶á‡á¶áá¶á…á€áŸ’ášá€á˜áŸ’á–á»á‡á¶</h2>
            <h2 class="moul-font text-[13px] text-blue-900">á‡á¶áá· áŸá¶áŸá“á¶ á–áŸ’ášáŸ‡á˜á á¶á€áŸ’áŸááŸ’áš</h2>
            <div class="flex justify-center items-center gap-1 opacity-30 mt-1">
                <div class="w-2 h-2 rounded-full bg-blue-900"></div>
                <div class="w-16 h-[1px] bg-blue-900"></div>
                <div class="w-2 h-2 rounded-full bg-blue-900"></div>
            </div>
        </div>

        <div class="mt-2 text-[11px] font-bold text-blue-900 leading-tight">
            <p>á˜á“áŸ’á‘á¸ášá¢á”áŸ‹ášáŸ† á™á»áœá‡á“ á“á·á„á€á¸á¡á¶ ááŸááŸ’áá€áŸ†á–á„áŸ‹á†áŸ’á“á¶áŸ†á„</p>
            <p>á€á¶ášá·á™á¶á›áŸá™á¢á”áŸ‹ášáŸ† á™á»áœá‡á“ á“á·á„á€á¸á¡á¶ áŸáŸ’ášá»á€á€áŸ†á–á„áŸ‹ááŸ’ášá¡á¶á…</p>
            <p>áœá·á‘áŸ’á™á¶á›áŸá™ á áŸŠá»á“ áŸáŸ‚á“ á€áŸ†á–á„áŸ‹ááŸ’ášá¡á¶á…</p>
        </div>

        <h1 class="moul-font text-red-600 text-center text-xl mt-6 mb-4">áá¶ášá¶á„á›á‘áŸ’á’á•á›áŸá·á€áŸ’áŸá¶ášá”áŸáŸ‹áŸá·áŸáŸ’áŸá”áŸ’ášá…á¶áŸ† <span id="resMonth">...</span></h1>

        <div class="grid grid-cols-2 gap-y-2 text-[13px] font-bold mt-2 px-4 border-l-4 border-blue-600 py-1">
            <p>á‚áŸ„ááŸ’áá“á¶á˜-á“á¶á˜ áŸ– <span id="resName" class="text-blue-800 moul-font ml-2">...</span></p>
            <p>á—áŸá‘ áŸ– <span id="resGender" class="text-blue-800 ml-2">...</span></p>
            <p>ááŸ’á„áŸƒááŸ‚á†áŸ’á“á¶áŸ†á€áŸ†áá¾á áŸ– <span id="resDOB" class="text-blue-800 ml-2">...</span></p>
            <p>ááŸ’á“á¶á€áŸ‹á‘á¸ áŸ– <span id="resGrade" class="text-blue-800 ml-2">...</span></p>
            <p>á¢ááŸ’áá›áŸá áŸ– <span id="resId" class="text-blue-800 ml-2">...</span></p>
            <p>á†áŸ’á“á¶áŸ†áŸá·á€áŸ’áŸá¶ áŸ– <span class="text-blue-800 ml-2">áŸ¢áŸ áŸ¢áŸ¥-áŸ¢áŸ áŸ¢áŸ¦</span></p>
        </div>

        <div class="sketch-summary shadow-sm">
            <div class="sketch-item">
                <p class="sketch-label">á˜á’áŸ’á™á˜á—á¶á‚</p>
                <p id="avgScore" class="sketch-value text-blue-600">0.00</p>
            </div>
            <div class="sketch-item">
                <p class="sketch-label">á…áŸ†áá¶ááŸ‹ááŸ’á“á¶á€áŸ‹</p>
                <p id="rank" class="sketch-value text-red-500">0</p>
            </div>
            <div class="sketch-item">
                <p class="sketch-label">á“á·á‘áŸ’á‘áŸáŸášá½á˜</p>
                <p id="gradeResult" class="sketch-value text-emerald-500">-</p>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th class="w-10">á›.áš</th>
                    <th class="w-48">á˜á»ááœá·á‡áŸ’á‡á¶</th>
                    <th class="w-24">á–á·á“áŸ’á‘á»á¢áá·á”ášá˜á¶</th>
                    <th class="w-24">á–á·á“áŸ’á‘á»á‘á‘á½á›á”á¶á“</th>
                    <th class="w-40">á€áŸ’ášá¶á”áœá·á—á¶á‚ (%)</th>
                    <th class="w-16">á“á·á‘áŸ’á‘áŸáŸ</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="font-bold"></tbody>
            <tfoot>
                <tr class="bg-blue-50/50">
                    <td colspan="2" class="subject-col text-blue-900 uppercase">á–á·á“áŸ’á‘á»áŸášá»á”</td>
                    <td id="totalMax" class="font-black text-center text-gray-500">0</td>
                    <td id="totalScore" class="font-black text-center text-blue-700">0</td>
                    <td colspan="2" class="text-right pr-4 text-[11px] text-gray-400 italic">áŸá˜á·á‘áŸ’á’á•á›áŸá·á€áŸ’áŸá¶á‚á·áá‡á¶á—á¶á‚ášá™</td>
                </tr>
            </tfoot>
        </table>

        <div class="mt-8 flex justify-between items-start px-4">
            <div class="text-center">
                <p class="font-bold text-[11px]">á”á¶á“áƒá¾á‰ á“á·á„á¯á€á—á¶á–</p>
                <p class="moul-font text-[11px] text-blue-900 mt-1">á“á¶á™á€áŸá¶á›á¶</p>
                <div class="h-24"></div>
            </div>
            <div class="text-center">
                <p id="footerDate" class="text-[10px] text-gray-600">...</p>
                <p id="footerLunar" class="text-[10px] text-gray-500 mb-1">...</p>
                <p class="moul-font text-[11px] text-blue-900 mt-1">á‚áŸ’ášá¼á”á“áŸ’á‘á»á€ááŸ’á“á¶á€áŸ‹</p>
                <div class="h-24"></div>
            </div>
        </div>
    </div>

    <!-- Bottom Action Buttons -->
    <div id="action-buttons" class="no-print mt-6 border-t pt-6 hidden flex-col items-center gap-6 mb-10">
        <div class="flex justify-center gap-4 w-full flex-wrap">
            <button onclick="downloadPDF()" class="bg-emerald-600 text-white px-10 py-3 rounded-2xl font-bold shadow-lg hover:scale-105 transition-all">á‘á¶á‰á™á€ PDF</button>
            <button onclick="window.print()" class="bg-slate-800 text-white px-10 py-3 rounded-2xl font-bold shadow-lg hover:scale-105 transition-all">á”áŸ„áŸ‡á–á»á˜áŸ’á–</button>
        </div>
        
        <!-- á”áŸŠá¼áá»á„ Telegram ááŸ’á˜á¸ á…áŸ†á“á½á“áŸ¢ áŸá˜áŸ’ášá¶á”áŸ‹áŸá·áŸáŸ’áŸ á“á·á„á˜á¶áá¶á”á·áá¶ -->
        <div class="flex flex-col md:flex-row justify-center gap-4 w-full mt-2">
            <button onclick="linkTelegram('Student')" class="flex-1 bg-sky-500 text-white px-6 py-3 rounded-2xl font-bold shadow-md hover:bg-sky-600 transition-all flex items-center justify-center gap-2">
                <svg viewBox="0 0 24 24" class="w-5 h-5 fill-current"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69.01-.03.01-.14-.07-.19-.08-.05-.19-.02-.27 0-.12.03-1.96 1.25-5.54 3.67-.52.36-1 .53-1.42.52-.47-.01-1.37-.26-2.03-.48-.82-.27-1.47-.42-1.42-.88.03-.24.29-.48.79-.74 3.08-1.34 5.15-2.23 6.19-2.68 2.95-1.26 3.56-1.48 3.96-1.48.09 0 .28.02.39.09.09.06.14.15.16.25.01.07.01.16-.01.27z"/></svg>
                á‘á‘á½á›á›á‘áŸ’á’á•á›ášá¶á›áŸ‹ááŸ‚ (áŸá˜áŸ’ášá¶á”áŸ‹áŸá·áŸáŸ’áŸ)
            </button>
            <button onclick="linkTelegram('Parent')" class="flex-1 bg-indigo-500 text-white px-6 py-3 rounded-2xl font-bold shadow-md hover:bg-indigo-600 transition-all flex items-center justify-center gap-2">
                <svg viewBox="0 0 24 24" class="w-5 h-5 fill-current"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69.01-.03.01-.14-.07-.19-.08-.05-.19-.02-.27 0-.12.03-1.96 1.25-5.54 3.67-.52.36-1 .53-1.42.52-.47-.01-1.37-.26-2.03-.48-.82-.27-1.47-.42-1.42-.88.03-.24.29-.48.79-.74 3.08-1.34 5.15-2.23 6.19-2.68 2.95-1.26 3.56-1.48 3.96-1.48.09 0 .28.02.39.09.09.06.14.15.16.25.01.07.01.16-.01.27z"/></svg>
                á‘á‘á½á›á›á‘áŸ’á’á•á›ášá¶á›áŸ‹ááŸ‚ (áŸá˜áŸ’ášá¶á”áŸ‹á˜á¶áá¶á”á·áá¶)
            </button>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alertModal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center backdrop-blur-sm no-print">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 shadow-2xl transform transition-all">
            <div class="text-center">
                <h3 class="text-lg leading-6 font-bold text-gray-900 mb-2" id="alertMessage">áŸá¶ášášáŸ†á›á¹á€</h3>
                <p id="alertSubMessage" class="text-sm text-gray-500 mb-4 hidden"></p>
                <button onclick="closeMessage()" class="mt-4 w-full inline-flex justify-center rounded-xl px-4 py-2 bg-blue-600 text-white">á™á›áŸ‹á–áŸ’ášá˜</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzoNcYGWYtiSxu6UCOx_5Ttlu99Ay-agxBJQKRjgWNpOr7X6cbYxXW0dkTFoOAeqILA/exec";
        
        // ğŸ”´ ááŸ’ášá¼áœá”áŸ’áá¼ášáˆáŸ’á˜áŸ„áŸ‡ Bot Username áá¶á„á€áŸ’ášáŸ„á˜á“áŸáŸ‡á‘áŸ…á‡á¶áˆáŸ’á˜áŸ„áŸ‡ Bot ášá”áŸáŸ‹á¢áŸ’á“á€ (á˜á·á“á”á¶á…áŸ‹áŠá¶á€áŸ‹áŸá‰áŸ’á‰á¶ @ á‘áŸ)
        const TELEGRAM_BOT_USERNAME = "kampongtralach_bot"; 
        
        const SUBJECTS = ["á—á¶áŸá¶ááŸ’á˜áŸ‚áš", "áŸá¸á›á’á˜áŸŒá–á›ášáŠáŸ’á‹", "á”áŸ’ášáœááŸ’áá·áœá·á‘áŸ’á™á¶", "á—á¼á˜á·áœá·á‘áŸ’á™á¶", "á‚áá·ááœá·á‘áŸ’á™á¶", "ášá¼á”áœá·á‘áŸ’á™á¶", "á‚á¸á˜á¸áœá·á‘áŸ’á™á¶", "á‡á¸áœáœá·á‘áŸ’á™á¶", "á•áŸ‚á“áŠá¸áœá·á‘áŸ’á™á¶", "á—á¶áŸá¶á¢á„áŸ‹á‚áŸ’á›áŸáŸ", "á€á¸á¡á¶", "á€áŸá·á€á˜áŸ’á˜", "á”á…áŸ’á…áŸá€áœá·á‘áŸ’á™á¶", "á”áŸ†áá·á“", "áŸá»áá—á¶á–"];

        function getGrade(percent) {
            if (percent >= 90) return "A"; if (percent >= 80) return "B";
            if (percent >= 70) return "C"; if (percent >= 60) return "D";
            if (percent >= 50) return "E"; return "F";
        }
        function getBarColor(percent) {
            if (percent >= 80) return "#10b981"; if (percent >= 60) return "#3b82f6"; 
            if (percent >= 50) return "#f59e0b"; return "#ef4444"; 
        }

        function showMessage(msg, subMsg = "") {
            document.getElementById('alertMessage').innerText = msg;
            if(subMsg) {
                document.getElementById('alertSubMessage').innerText = subMsg;
                document.getElementById('alertSubMessage').classList.remove('hidden');
            } else {
                document.getElementById('alertSubMessage').classList.add('hidden');
            }
            document.getElementById('alertModal').classList.remove('hidden');
        }
        function closeMessage() { document.getElementById('alertModal').classList.add('hidden'); }

        // á˜á»áá„á¶ášáŸá˜áŸ’ášá¶á”áŸ‹á—áŸ’á‡á¶á”áŸ‹ Telegram áŠáŸ„á™á¢á¼á‘á¶á‰á™á€á¢ááŸ’áá›áŸááŸá·áŸáŸ’áŸ
        function linkTelegram(type) {
            const stuId = document.getElementById('resId').innerText;
            if(!stuId || stuId === '...') {
                showMessage("áŸá¼á˜áŸáŸ’áœáŸ‚á„ášá€áŸá·áŸáŸ’áŸá‡á¶á˜á»á“áŸá·á“!");
                return;
            }
            if(TELEGRAM_BOT_USERNAME === "@kampongtralach_bot") {
                showMessage("á‡á˜áŸ’ášá¶á”áŸá½áš Admin!", "áŸá¼á˜á…á¼á›á‘áŸ…á€áŸ‚á”áŸ’ášáŸ‚á¢ááŸáš TELEGRAM_BOT_USERNAME á€áŸ’á“á»á„á€á¼áŠ HTML áŠá¶á€áŸ‹áˆáŸ’á˜áŸ„áŸ‡ Bot ášá”áŸáŸ‹á¢áŸ’á“á€á‡á¶á˜á»á“áŸá·á“áŸ”");
                return;
            }
            
            // á”á„áŸ’á€á¾á Deep Link (á§á‘á¶á ášááŸ: https://t.me/HSKT_Bot?start=Student_001)
            const payload = `${type}_${stuId}`;
            const deepLinkUrl = `https://t.me/${TELEGRAM_BOT_USERNAME}?start=${payload}`;
            
            // á”á¾á€ Telegram App
            window.open(deepLinkUrl, '_blank');
        }

        async function handleSearch() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            const month = document.getElementById('monthSelect').value;
            if (!query) {
                showMessage("áŸá¼á˜á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡ á¬á¢ááŸ’áá›áŸááŸá·áŸáŸ’áŸ!");
                return false;
            }

            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('searchBtn').disabled = true;
            
            try {
                const dataUrl = `${API_URL}?month=${encodeURIComponent(month)}`;
                const configUrl = `${API_URL}?month=Config_MaxScores`;
                
                const [dataRes, configRes] = await Promise.all([
                    fetch(dataUrl),
                    fetch(configUrl)
                ]);
                
                const dataText = await dataRes.text();
                const configText = await configRes.text();
                
                let data, config;
                try {
                    data = JSON.parse(dataText);
                    config = JSON.parse(configText);
                } catch (parseError) {
                    console.error("á€áŸ†á á»áŸá€áŸ’á“á»á„á€á¶ášá¢á¶á“á‘á·á“áŸ’á“á“áŸá™ (Not JSON):", dataText.substring(0, 100));
                    showMessage("á”áŸ’ášá–áŸá“áŸ’á’ášá¢á¶á€áŸ‹ášá¢á½á›!", "Server á˜á·á“á”á¶á“á”á‰áŸ’á‡á¼á“á‘á·á“áŸ’á“á“áŸá™ááŸ’ášá¹á˜ááŸ’ášá¼áœá˜á€áœá·á‰á‘áŸáŸ”");
                    return false;
                }

                const s = data.find(i => i.ID?.toString().toLowerCase() === query || i.Name?.toString().toLowerCase().includes(query));

                if (s) {
                    const gradeConfig = config.find(c => c["á€á˜áŸ’ášá·áááŸ’á“á¶á€áŸ‹"]?.toString().trim() === s.Grade?.toString().trim());
                    
                    document.getElementById('resName').innerText = s.Name;
                    document.getElementById('resId').innerText = s.ID;
                    document.getElementById('resGrade').innerText = s.Grade;
                    document.getElementById('resGender').innerText = s.Gender || '...';
                    document.getElementById('resDOB').innerText = s.DOB || '...';
                    document.getElementById('resMonth').innerText = month;
                    
                    document.getElementById('totalScore').innerText = s.Total;
                    document.getElementById('avgScore').innerText = s.Average;
                    document.getElementById('rank').innerText = s.Rank;
                    document.getElementById('gradeResult').innerText = s.Grade_Result || getGrade(parseFloat(s.Average)*2);
                    document.getElementById('footerDate').innerText = s.DateSolar || '';
                    document.getElementById('footerLunar').innerText = s.DateLunar || '';

                    let tableHtml = ""; let totalMax = 0; let displayIndex = 1;

                    SUBJECTS.forEach((sub) => {
                        const score = parseFloat(s[sub]);
                        const max = gradeConfig ? parseFloat(gradeConfig[sub]) : 50;
                        if (!isNaN(score)) {
                            totalMax += max;
                            const percent = Math.min((score / max) * 100, 100);
                            const grade = getGrade(percent);
                            const barColor = getBarColor(percent);
                            
                            tableHtml += `
                                <tr>
                                    <td class="text-gray-400 font-normal">${displayIndex}</td>
                                    <td class="subject-col">${sub}</td>
                                    <td class="text-gray-400">${max}</td>
                                    <td class="text-blue-700">${score}</td>
                                    <td class="px-3">
                                        <div class="flex items-center gap-2">
                                            <div class="progress-container"><div class="progress-bar" style="width: ${percent}%; background-color: ${barColor};"></div></div>
                                            <span class="text-[9px] w-8 text-left text-gray-500">${Math.round(percent)}%</span>
                                        </div>
                                    </td>
                                    <td class="grade-${grade}">${grade}</td>
                                </tr>`;
                            displayIndex++;
                        }
                    });

                    document.getElementById('tableBody').innerHTML = tableHtml;
                    document.getElementById('totalMax').innerText = totalMax;
                    
                    document.getElementById('capture-area').classList.remove('hidden');
                    const actionBtns = document.getElementById('action-buttons');
                    actionBtns.classList.remove('hidden');
                    actionBtns.classList.add('flex'); 
                    
                    return true;
                } else {
                    showMessage("ášá€á˜á·á“áƒá¾á‰á‘á·á“áŸ’á“á“áŸá™!", `á˜á·á“á˜á¶á“á›á‘áŸ’á’á•á›áŸá˜áŸ’ášá¶á”áŸ‹á¢ááŸ’áá›áŸá/áˆáŸ’á˜áŸ„áŸ‡ "${query}" á€áŸ’á“á»á„ááŸ‚á“áŸáŸ‡á‘áŸáŸ”`);
                    return false;
                }
            } catch (e) {
                console.error("Fetch Error:", e);
                showMessage("á˜á¶á“á”á‰áŸ’á á¶á—áŸ’á‡á¶á”áŸ‹á‘áŸ…á€á¶á“áŸ‹ Server!", "áŸá¼á˜á–á·á“á·ááŸ’á™á˜á¾á›á¢á»á¸á“á’áºáá·á á¬ URL áŠáŸ‚á›á”á¶á“áŠá¶á€áŸ‹áŸ”");
                return false;
            } finally {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('searchBtn').disabled = false;
            }
        }

        function downloadPDF() {
            const element = document.getElementById('capture-area');
            const name = document.getElementById('resName').innerText;
            const opt = {
                margin: 0,
                filename: `á›á‘áŸ’á’á•á›_${name}.pdf`,
                image: { type: 'jpeg', quality: 1 },
                html2canvas: { scale: 3, useCORS: true, letterRendering: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        let html5QrcodeScanner;
        function startScanner() {
            const readerDiv = document.getElementById('qr-reader');
            if (readerDiv.classList.contains('hidden')) {
                readerDiv.classList.remove('hidden');
                if (!html5QrcodeScanner) {
                    html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", { fps: 10, qrbox: 250 });
                    html5QrcodeScanner.render(
                        (decodedText) => {
                            document.getElementById('searchInput').value = decodedText;
                            document.getElementById('qr-reader').classList.add('hidden');
                            html5QrcodeScanner.clear();
                            handleSearch();
                        },
                        (err) => { }
                    );
                }
            } else {
                readerDiv.classList.add('hidden');
                if(html5QrcodeScanner) { html5QrcodeScanner.clear(); html5QrcodeScanner = null; }
            }
        }

        function getUrlParams(callback) {
            if (typeof google !== 'undefined' && google.script && google.script.url) {
                google.script.url.getLocation(function(location) {
                    callback(location.parameter);
                });
            } else {
                const params = new URLSearchParams(window.location.search);
                const paramObj = {};
                for (const [key, value] of params.entries()) {
                    paramObj[key] = value;
                }
                callback(paramObj);
            }
        }

        window.onload = function() {
            getUrlParams(async function(params) {
                const stuId = params.id;
                const month = params.month;
                const autoPdf = params.autoPdf;

                if(stuId) {
                    document.getElementById('searchInput').value = stuId;
                    if(month) {
                        const select = document.getElementById('monthSelect');
                        for(let i=0; i<select.options.length; i++) {
                            if(select.options[i].value === month) {
                                select.selectedIndex = i;
                                break;
                            }
                        }
                    }
                    setTimeout(async () => {
                        const isFound = await handleSearch();
                        if(isFound && autoPdf === 'true') {
                            setTimeout(() => { downloadPDF(); }, 1500);
                        }
                    }, 500);
                }
            });
        };
    </script>
</body>
</html>
